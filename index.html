<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASCAR Practice Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        /* Practice Viewer Specific Styles */
        .hover-chart-panel {
            min-height: 450px;
        }

        .hover-instruction {
            text-align: center;
            color: #444;
            padding: 100px 20px;
            font-size: 1.1rem;
        }

        .hover-instruction span {
            color: #39ff14;
        }

        .driver-highlight {
            display: none;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(57, 255, 20, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(57, 255, 20, 0.2);
        }

        .driver-highlight.active {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .driver-highlight-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
        }

        .driver-highlight-team {
            font-size: 0.85rem;
            color: #666;
            margin-top: 3px;
        }

        .driver-highlight-stats {
            display: flex;
            gap: 40px;
        }

        .highlight-stat {
            text-align: center;
        }

        .highlight-stat-value {
            font-size: 1.3rem;
            color: #39ff14;
            font-weight: 600;
            font-family: 'Consolas', monospace;
        }

        .highlight-stat-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Heatmap View */
        .heatmap-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 800px;
        }

        .heatmap-table {
            border-collapse: collapse;
            font-size: 0.7rem;
        }

        .heatmap-table th {
            background: #0d0d0d;
            color: #39ff14;
            padding: 6px 4px;
            text-align: center;
            font-weight: 600;
            border: 1px solid rgba(57, 255, 20, 0.1);
            position: sticky;
            top: 0;
            z-index: 2;
            min-width: 42px;
            font-size: 0.65rem;
        }

        .heatmap-table th.driver-header {
            position: sticky;
            left: 0;
            z-index: 3;
            text-align: left;
            min-width: 140px;
            background: #0d0d0d;
        }

        .heatmap-table th.avg-header {
            background: #1a1a1a;
            color: #fff;
            min-width: 50px;
        }

        .heatmap-table td {
            padding: 4px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.03);
            font-family: 'Consolas', monospace;
        }

        .heatmap-table td.driver-cell {
            position: sticky;
            left: 0;
            background: #0d0d0d;
            text-align: left;
            font-family: 'Segoe UI', sans-serif;
            font-weight: 500;
            white-space: nowrap;
            z-index: 1;
        }

        .heatmap-table td.avg-cell {
            background: rgba(0, 0, 0, 0.3);
            font-weight: 600;
            min-width: 50px;
        }

        .heatmap-table td.lap-cell {
            min-width: 42px;
            height: 22px;
            cursor: default;
            padding: 2px 1px;
            font-size: 0.6rem;
        }

        .heatmap-table tr:hover td.driver-cell {
            background: #1a1a1a;
        }

        .lap-time-cell {
            border-radius: 2px;
            padding: 3px 2px;
        }

        /* Color legend */
        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .legend-title {
            color: #666;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .legend-scale {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-bar {
            width: 150px;
            height: 12px;
            background: linear-gradient(90deg, #00ff00, #88ff00, #ffff00, #ff8800, #ff0000);
            border-radius: 3px;
        }

        .legend-label {
            font-size: 0.75rem;
            color: #888;
        }

        .heatmap-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* Averages Table */
        .averages-panel {
            margin-bottom: 25px;
        }

        .averages-table {
            width: 100%;
            border-collapse: collapse;
        }

        .averages-table th {
            text-align: left;
            padding: 10px 8px;
            color: #39ff14;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            border-bottom: 2px solid rgba(57, 255, 20, 0.3);
            background: #0d0d0d;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .averages-table th.avg-col {
            text-align: center;
            background: linear-gradient(180deg, rgba(57, 255, 20, 0.1), transparent);
        }

        .averages-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 0.85rem;
        }

        .averages-table td.avg-value {
            text-align: center;
            font-family: 'Consolas', monospace;
            font-weight: 500;
        }

        .averages-table tr:hover {
            background: rgba(57, 255, 20, 0.03);
        }

        /* Compare Drivers View */
        .compare-selected {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            margin-bottom: 15px;
            min-height: 44px;
            align-items: center;
        }

        .compare-selected .no-selection {
            color: #444;
            font-size: 0.85rem;
        }

        .compare-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #000;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .compare-chip:hover {
            transform: scale(1.05);
        }

        .compare-chip .remove-chip {
            font-size: 1rem;
            line-height: 1;
            opacity: 0.7;
        }

        .compare-chip:hover .remove-chip {
            opacity: 1;
        }

        .driver-row.compare-selected-row {
            background: rgba(57, 255, 20, 0.15);
        }

        .driver-row.compare-selected-row td:first-child {
            border-left: 3px solid #39ff14;
        }

        .compare-instruction {
            text-align: center;
            color: #444;
            padding: 80px 20px;
            font-size: 1rem;
        }

        .compare-stats {
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .compare-stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .compare-stats-table th {
            text-align: center;
            padding: 10px 8px;
            color: #39ff14;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(57, 255, 20, 0.2);
            background: #0d0d0d;
        }

        .compare-stats-table th:first-child {
            text-align: left;
        }

        .compare-stats-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-family: 'Consolas', monospace;
        }

        .compare-stats-table td:first-child {
            text-align: left;
            font-family: 'Segoe UI', sans-serif;
            font-weight: 500;
        }

        .compare-stats-table td.best-in-column {
            color: #39ff14;
            font-weight: 700;
        }

        .compare-driver-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .compare-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .averages-table-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .averages-table-container::-webkit-scrollbar {
            width: 6px;
        }

        .averages-table-container::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .averages-table-container::-webkit-scrollbar-thumb {
            background: #39ff14;
            border-radius: 3px;
        }

        /* Advanced TEST View Styles */
        .advanced-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            align-items: center;
        }

        .advanced-controls-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .advanced-controls-group label {
            color: #888;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .toggle-btn {
            background: transparent;
            border: 1px solid rgba(57, 255, 20, 0.3);
            color: #666;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toggle-btn:hover {
            border-color: rgba(57, 255, 20, 0.5);
            color: #999;
        }

        .toggle-btn.active {
            background: rgba(57, 255, 20, 0.15);
            border-color: #39ff14;
            color: #39ff14;
        }

        .export-btn {
            background: linear-gradient(135deg, #4488ff, #2266dd);
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: auto;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(68, 136, 255, 0.3);
        }

        .export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .advanced-heatmap-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 800px;
        }

        .advanced-heatmap-table {
            border-collapse: collapse;
            font-size: 0.7rem;
        }

        .advanced-heatmap-table th {
            background: #0d0d0d;
            color: #39ff14;
            padding: 6px 4px;
            text-align: center;
            font-weight: 600;
            border: 1px solid rgba(57, 255, 20, 0.1);
            position: sticky;
            top: 0;
            z-index: 2;
            min-width: 42px;
            font-size: 0.65rem;
        }

        .advanced-heatmap-table th.driver-header {
            position: sticky;
            left: 0;
            z-index: 3;
            text-align: left;
            min-width: 140px;
            background: #0d0d0d;
        }

        .advanced-heatmap-table th.rank-header {
            background: #1a0a2a;
            color: #a855f7;
            min-width: 45px;
        }

        .advanced-heatmap-table th.avg-header {
            background: #1a1a1a;
            color: #fff;
            min-width: 50px;
        }

        .advanced-heatmap-table td {
            padding: 4px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.03);
            font-family: 'Consolas', monospace;
        }

        .advanced-heatmap-table td.driver-cell {
            position: sticky;
            left: 0;
            background: #0d0d0d;
            text-align: left;
            font-family: 'Segoe UI', sans-serif;
            font-weight: 500;
            white-space: nowrap;
            z-index: 1;
        }

        .advanced-heatmap-table td.rank-cell {
            background: rgba(168, 85, 247, 0.1);
            color: #a855f7;
            font-weight: 600;
            min-width: 45px;
        }

        .advanced-heatmap-table td.rank-cell.rank-top3 {
            color: #39ff14;
            background: rgba(57, 255, 20, 0.15);
        }

        .advanced-heatmap-table td.rank-cell.rank-top10 {
            color: #88ff44;
            background: rgba(136, 255, 68, 0.1);
        }

        .advanced-heatmap-table td.avg-cell {
            background: rgba(0, 0, 0, 0.3);
            font-weight: 600;
            min-width: 50px;
        }

        .advanced-heatmap-table td.lap-cell {
            min-width: 42px;
            height: 22px;
            cursor: default;
            padding: 2px 1px;
            font-size: 0.6rem;
        }

        .advanced-heatmap-table tr:hover td.driver-cell {
            background: #1a1a1a;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>NASCAR Practice Viewer</h1>
            <p class="subtitle">Lap-by-Lap Performance Analysis</p>
            <div class="nav-links">
                <a href="index.html" class="active">Practice Viewer</a>
                <a href="weekend.html">Weekend Viewer</a>
                <a href="loopstats.html">Loop Stats</a>
                <a href="pitdata.html">Pit Data</a>
                <a href="odds.html">DK Odds</a>
            </div>
        </header>

        <div class="race-selector">
            <div class="selector-group">
                <label for="yearSelect">Year</label>
                <select id="yearSelect">
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                </select>
            </div>
            <div class="selector-group">
                <label for="seriesSelect">Series</label>
                <select id="seriesSelect">
                    <option value="1" selected>Cup Series</option>
                    <option value="2">Xfinity Series</option>
                    <option value="3">Craftsman Truck Series</option>
                </select>
            </div>
            <div class="selector-group">
                <label for="raceSelect">Race</label>
                <select id="raceSelect">
                    <option value="">Select a race...</option>
                </select>
            </div>
            <button class="load-btn" id="loadRaceBtn" disabled>Load Practice</button>
        </div>

        <div class="current-race-info" id="currentRaceInfo" style="display: none;">
            <h3 id="currentRaceName">--</h3>
            <p id="currentTrackName">--</p>
        </div>

        <div class="session-info">
            <div class="session-item">
                <span class="session-label">Series:</span>
                <span class="session-value">NASCAR Craftsman Truck Series</span>
            </div>
            <div class="session-item">
                <span class="session-label">Session:</span>
                <span class="session-value">Practice</span>
            </div>
            <div class="session-item">
                <span class="session-label">Data:</span>
                <span class="data-indicator"><span class="data-dot"></span> LIVE FEED</span>
            </div>
            <div class="session-item">
                <label class="auto-refresh-toggle">
                    <input type="checkbox" id="autoRefreshToggle">
                    <span class="session-label">Auto-Refresh (5s)</span>
                </label>
            </div>
        </div>

        <div class="panel" style="margin-bottom: 25px;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalLaps">--</div>
                    <div class="stat-label">Total Laps</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="fastestLap">--</div>
                    <div class="stat-label">Fastest Lap (s)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="topSpeed">--</div>
                    <div class="stat-label">Top Speed (mph)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeDrivers">--</div>
                    <div class="stat-label">Active Drivers</div>
                </div>
            </div>
        </div>

        <!-- View Tabs -->
        <div class="view-tabs">
            <button class="view-tab active" data-view="standings">Standings View</button>
            <button class="view-tab" data-view="averages">Lap Averages</button>
            <button class="view-tab" data-view="heatmap">Lap Heatmap</button>
            <button class="view-tab" data-view="compare">Compare Drivers</button>
            <button class="view-tab" data-view="advanced">Advanced TEST</button>
        </div>

        <!-- Standings View (Original) -->
        <div class="view-content active" id="standings-view">
            <div class="dashboard">
            <div class="panel">
                <h2 class="panel-title">Practice Standings</h2>
                <p class="click-hint">Click a driver to lock their stats â€¢ Click again to unlock</p>
                <div class="drivers-table-container">
                    <table class="drivers-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Driver</th>
                                <th>Best</th>
                                <th>Laps</th>
                            </tr>
                        </thead>
                        <tbody id="driversTableBody">
                            <tr><td colspan="4" class="loading" style="color: #666; text-align: center; padding: 40px;">
                                Select a race from the dropdown above to view practice data
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="panel hover-chart-panel">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="panel-title">Lap Time Analysis</h2>
                    <button class="clear-btn" id="clearBtn" style="display: none;" onclick="clearSelection()">Clear Selection</button>
                </div>
                <div class="driver-highlight" id="driverHighlight">
                    <div>
                        <div class="driver-highlight-name" id="highlightName"></div>
                        <div class="driver-highlight-team" id="highlightTeam"></div>
                    </div>
                    <div class="driver-highlight-stats">
                        <div class="highlight-stat">
                            <div class="highlight-stat-value" id="highlightBest"></div>
                            <div class="highlight-stat-label">Best Lap</div>
                        </div>
                        <div class="highlight-stat">
                            <div class="highlight-stat-value" id="highlightAvg"></div>
                            <div class="highlight-stat-label">Avg Lap</div>
                        </div>
                        <div class="highlight-stat">
                            <div class="highlight-stat-value" id="highlightLaps"></div>
                            <div class="highlight-stat-label">Total Laps</div>
                        </div>
                        <div class="highlight-stat">
                            <div class="highlight-stat-value" id="highlightTopSpeed"></div>
                            <div class="highlight-stat-label">Top Speed</div>
                        </div>
                    </div>
                </div>
                <div class="hover-instruction" id="hoverInstruction">
                    Hover over a <span>driver's name</span> to see their lap-by-lap performance<br>
                    <span style="font-size: 0.85rem; color: #333;">Click to lock the view</span>
                </div>
                <div class="chart-container" id="chartContainer" style="display: none;">
                    <canvas id="lapChart"></canvas>
                </div>
            </div>
        </div>
        </div>

        <!-- Lap Averages View -->
        <div class="view-content" id="averages-view">
            <div class="panel averages-panel">
                <h2 class="panel-title">Best Consecutive Lap Averages</h2>
                <p style="color: #555; font-size: 0.8rem; margin-bottom: 15px;">
                    Shows the best consecutive N lap average for each driver. Lower is better. Click headers to sort.
                </p>
                <div class="averages-table-container">
                    <table class="averages-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">Pos</th>
                                <th class="sortable" data-sort="name">Driver <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="best">Best Lap <span class="sort-arrow"></span></th>
                                <th class="avg-col sortable" data-sort="avg5">Best 5 Avg <span class="sort-arrow"></span></th>
                                <th class="avg-col sortable active-sort" data-sort="avg10">Best 10 Avg <span class="sort-arrow">â–²</span></th>
                                <th class="avg-col sortable" data-sort="avg15">Best 15 Avg <span class="sort-arrow"></span></th>
                                <th class="avg-col sortable" data-sort="avg20">Best 20 Avg <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="laps">Laps <span class="sort-arrow"></span></th>
                            </tr>
                        </thead>
                        <tbody id="averagesTableBody">
                            <tr><td colspan="8" style="color: #666; text-align: center; padding: 40px;">
                                Select a race to view lap averages
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Compare Drivers View -->
        <div class="view-content" id="compare-view">
            <div class="dashboard">
                <div class="panel">
                    <h2 class="panel-title">Select Drivers (up to 5)</h2>
                    <p class="click-hint">Click drivers to add/remove from comparison</p>
                    <div class="compare-selected" id="compareSelected">
                        <span class="no-selection">No drivers selected</span>
                    </div>
                    <div class="drivers-table-container">
                        <table class="drivers-table">
                            <thead>
                                <tr>
                                    <th>Pos</th>
                                    <th>Driver</th>
                                    <th>Best</th>
                                    <th>Laps</th>
                                </tr>
                            </thead>
                            <tbody id="compareDriversTableBody">
                                <tr><td colspan="4" style="color: #666; text-align: center; padding: 40px;">
                                    Select a race to compare drivers
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="panel">
                    <h2 class="panel-title">Lap Time Comparison</h2>
                    <div class="compare-stats" id="compareStats" style="display: none;">
                        <table class="compare-stats-table">
                            <thead>
                                <tr>
                                    <th>Driver</th>
                                    <th>Best Lap</th>
                                    <th>Avg Lap</th>
                                    <th>Best 5</th>
                                    <th>Best 10</th>
                                    <th>Laps</th>
                                    <th>Consistency</th>
                                </tr>
                            </thead>
                            <tbody id="compareStatsBody"></tbody>
                        </table>
                    </div>
                    <div class="compare-instruction" id="compareInstruction">
                        Select drivers from the list to compare their lap times
                    </div>
                    <div class="chart-container" id="compareChartContainer" style="display: none; height: 400px;">
                        <canvas id="compareChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Heatmap View -->
        <div class="view-content" id="heatmap-view">
            <div class="panel">
                <h2 class="panel-title">Lap Time Heatmap</h2>
                <div class="heatmap-controls">
                    <div class="heatmap-legend">
                        <span class="legend-title">Lap Time:</span>
                        <div class="legend-scale">
                            <span class="legend-label">Fastest</span>
                            <div class="legend-bar"></div>
                            <span class="legend-label">Slowest</span>
                        </div>
                    </div>
                    <p style="color: #555; font-size: 0.75rem;">Click column headers to sort</p>
                </div>
                <div class="heatmap-container" id="heatmapContainer">
                    <p style="color: #666; text-align: center; padding: 40px;">
                        Select a race to view the lap heatmap
                    </p>
                </div>
            </div>
        </div>

        <!-- Advanced TEST View -->
        <div class="view-content" id="advanced-view">
            <div class="panel">
                <h2 class="panel-title">Advanced TEST</h2>
                <p style="color: #555; font-size: 0.8rem; margin-bottom: 15px;">
                    Detailed lap-by-lap analysis with rank-based statistics. Toggle rank columns to see driver rankings for consecutive lap averages.
                </p>
                <div class="advanced-controls">
                    <div class="advanced-controls-group">
                        <label>Show Avg Ranks:</label>
                        <button class="toggle-btn" id="toggleRank5" data-rank="5">5 Lap Rank</button>
                        <button class="toggle-btn" id="toggleRank10" data-rank="10">10 Lap Rank</button>
                        <button class="toggle-btn" id="toggleRank15" data-rank="15">15 Lap Rank</button>
                        <button class="toggle-btn" id="toggleRank20" data-rank="20">20 Lap Rank</button>
                    </div>
                    <button class="export-btn" id="exportExcelBtn" disabled>ðŸ“Š Export to Excel</button>
                </div>
                <div class="heatmap-controls">
                    <div class="heatmap-legend">
                        <span class="legend-title">Lap Time:</span>
                        <div class="legend-scale">
                            <span class="legend-label">Fastest</span>
                            <div class="legend-bar"></div>
                            <span class="legend-label">Slowest</span>
                        </div>
                    </div>
                    <p style="color: #555; font-size: 0.75rem;">Click column headers to sort</p>
                </div>
                <div class="advanced-heatmap-container" id="advancedHeatmapContainer">
                    <p style="color: #666; text-align: center; padding: 40px;">
                        Select a race to view advanced practice analytics
                    </p>
                </div>
            </div>
        </div>

        <footer>
            NASCAR Practice Viewer &copy; 2025 | Data from NASCAR Live Feed
        </footer>
    </div>

    <script>
        let DATA_URL = 'https://cf.nascar.com/cacher/live/series_3/5506/lap-times-practice.json';
        const RACE_LIST_BASE_URL = 'https://cf.nascar.com/cacher/';
        
        let practiceData = [];
        let lapChart = null;
        let selectedDriverIndex = null;
        let isLocked = false;
        let raceListData = {};
        let currentlyLoadedRace = null;
        let autoRefreshInterval = null;
        const AUTO_REFRESH_INTERVAL_MS = 5000; // 5 seconds

        const chartContainer = document.getElementById('chartContainer');
        const hoverInstruction = document.getElementById('hoverInstruction');
        const driverHighlight = document.getElementById('driverHighlight');
        const clearBtn = document.getElementById('clearBtn');

        // Race selector elements
        const yearSelect = document.getElementById('yearSelect');
        const seriesSelect = document.getElementById('seriesSelect');
        const raceSelect = document.getElementById('raceSelect');
        const loadRaceBtn = document.getElementById('loadRaceBtn');
        const currentRaceInfo = document.getElementById('currentRaceInfo');
        const currentRaceName = document.getElementById('currentRaceName');
        const currentTrackName = document.getElementById('currentTrackName');
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');

        // Series name mapping
        const seriesNames = {
            '1': 'NASCAR Cup Series',
            '2': 'NASCAR Xfinity Series',
            '3': 'NASCAR Craftsman Truck Series'
        };

        // Load race list for selected year
        async function loadRaceList() {
            const year = yearSelect.value;
            const raceListUrl = `${RACE_LIST_BASE_URL}${year}/race_list_basic.json`;
            
            raceSelect.innerHTML = '<option value="">Loading races...</option>';
            raceSelect.disabled = true;
            loadRaceBtn.disabled = true;

            try {
                const response = await fetch(raceListUrl);
                if (!response.ok) throw new Error('Failed to fetch race list');
                raceListData = await response.json();
                populateRaceDropdown();
            } catch (error) {
                console.error('Error loading race list:', error);
                raceSelect.innerHTML = '<option value="">Failed to load races</option>';
            }
        }

        // Populate race dropdown based on selected series
        function populateRaceDropdown() {
            const seriesId = seriesSelect.value;
            const seriesKey = `series_${seriesId}`;
            const races = raceListData[seriesKey] || [];

            raceSelect.innerHTML = '<option value="">Select a race...</option>';

            races.forEach(race => {
                const option = document.createElement('option');
                option.value = JSON.stringify({
                    race_id: race.race_id,
                    series_id: race.series_id,
                    race_season: race.race_season,
                    race_name: race.race_name,
                    track_name: race.track_name
                });
                
                // Format the date
                const raceDate = new Date(race.date_scheduled);
                const dateStr = raceDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                option.textContent = `${dateStr} - ${race.race_name} (${race.track_name})`;
                raceSelect.appendChild(option);
            });

            raceSelect.disabled = false;
            
            // Auto-select and load most recent race (last in the list)
            if (races.length > 0 && !currentlyLoadedRace) {
                // selectedIndex = races.length accounts for the "Select a race..." option at index 0
                // The last race is at index races.length (0 is placeholder, 1-N are races)
                raceSelect.selectedIndex = races.length;
                loadRaceBtn.disabled = false;
                // Auto-load the race
                loadSelectedRace();
            }
        }

        // Handle race selection
        function onRaceSelected() {
            loadRaceBtn.disabled = !raceSelect.value;
        }

        // Load practice data for selected race
        async function loadSelectedRace() {
            if (!raceSelect.value) return;

            const raceInfo = JSON.parse(raceSelect.value);
            const { race_id, series_id, race_season, race_name, track_name } = raceInfo;

            // Build the practice data URL
            DATA_URL = `https://cf.nascar.com/cacher/live/series_${series_id}/${race_id}/lap-times-practice.json`;
            
            // Mark that we've loaded a race
            currentlyLoadedRace = race_id;

            // Update current race info display
            currentRaceName.textContent = race_name;
            currentTrackName.textContent = `${track_name} â€¢ ${race_season}`;
            currentRaceInfo.style.display = 'block';

            // Update session info
            const seriesName = seriesNames[series_id.toString()] || 'NASCAR Series';
            document.querySelector('.session-info .session-value').textContent = seriesName;

            // Reset state
            clearSelection();
            
            // Load the data
            await loadData();

            // Start auto-refresh if toggle is enabled
            if (autoRefreshToggle.checked) {
                startAutoRefresh();
            }
        }

        // Event listeners for race selector
        yearSelect.addEventListener('change', loadRaceList);
        seriesSelect.addEventListener('change', populateRaceDropdown);
        raceSelect.addEventListener('change', onRaceSelected);
        loadRaceBtn.addEventListener('click', loadSelectedRace);

        // Auto-refresh event listener
        autoRefreshToggle.addEventListener('change', function() {
            if (this.checked && currentlyLoadedRace) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });

        // Start auto-refresh polling
        function startAutoRefresh() {
            stopAutoRefresh(); // Clear any existing interval
            autoRefreshInterval = setInterval(async () => {
                if (currentlyLoadedRace && autoRefreshToggle.checked) {
                    await refreshData();
                }
            }, AUTO_REFRESH_INTERVAL_MS);
        }

        // Stop auto-refresh polling
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Refresh data without showing loading spinner (for auto-refresh)
        async function refreshData() {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error('Failed to fetch data');
                const data = await response.json();
                processData(data);
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        // Fetch and process NASCAR data
        async function loadData() {
            // Show loading state
            document.getElementById('driversTableBody').innerHTML = `
                <tr><td colspan="4" class="loading">
                    <div class="loading-spinner"></div>
                    Loading practice data...
                </td></tr>
            `;
            
            // Reset stats
            document.getElementById('totalLaps').textContent = '--';
            document.getElementById('fastestLap').textContent = '--';
            document.getElementById('topSpeed').textContent = '--';
            document.getElementById('activeDrivers').textContent = '--';
            
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error('Failed to fetch data');
                const data = await response.json();
                processData(data);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('driversTableBody').innerHTML = `
                    <tr><td colspan="4" class="error-message">
                        No practice data available for this race.<br>
                        <span style="font-size: 0.8rem; color: #888;">Practice data may not be available yet or the session hasn't started.</span>
                    </td></tr>
                `;
            }
        }

        function processData(data) {
            // First pass: collect all lap times to calculate outlier thresholds
            const allRawLapTimes = data.laps.flatMap(driver => 
                driver.Laps.filter(lap => lap.LapTime && lap.LapTime > 10 && lap.LapTime < 60)
                    .map(lap => lap.LapTime)
            );
            
            // Calculate IQR-based outlier bounds
            const sorted = [...allRawLapTimes].sort((a, b) => a - b);
            const q1 = sorted[Math.floor(sorted.length * 0.25)];
            const q3 = sorted[Math.floor(sorted.length * 0.75)];
            const iqr = q3 - q1;
            const lowerBound = q1 - 1.5 * iqr;
            const upperBound = q3 + 1.5 * iqr;
            
            practiceData = data.laps.map(driver => {
                // Filter out invalid lap times (pit stops, cautions, outliers) AND the lap after an outlier
                const allLaps = driver.Laps;
                const validLaps = [];
                
                for (let i = 0; i < allLaps.length; i++) {
                    const lap = allLaps[i];
                    const isOutlier = !lap.LapTime || lap.LapTime < lowerBound || lap.LapTime > upperBound;
                    
                    // Check if previous lap was an outlier
                    const prevLap = i > 0 ? allLaps[i - 1] : null;
                    const prevWasOutlier = prevLap && (!prevLap.LapTime || prevLap.LapTime < lowerBound || prevLap.LapTime > upperBound);
                    
                    // Include lap only if it's not an outlier AND the previous lap wasn't an outlier
                    if (!isOutlier && !prevWasOutlier) {
                        validLaps.push(lap);
                    }
                }
                
                const lapTimes = validLaps.map(lap => lap.LapTime);
                const lapSpeeds = validLaps.map(lap => parseFloat(lap.LapSpeed));
                
                const bestLap = lapTimes.length > 0 ? Math.min(...lapTimes) : null;
                const avgLap = lapTimes.length > 0 ? lapTimes.reduce((a, b) => a + b, 0) / lapTimes.length : null;
                const topSpeed = lapSpeeds.length > 0 ? Math.max(...lapSpeeds) : null;

                return {
                    name: driver.FullName.replace(/\s*\(P\)\s*|\s*#\s*|\s*\(i\)\s*/g, '').trim(),
                    number: driver.Number,
                    manufacturer: driver.Manufacturer,
                    runningPos: driver.RunningPos,
                    lapTimes,
                    lapSpeeds: validLaps.map(lap => parseFloat(lap.LapSpeed)),
                    lapNumbers: validLaps.map(lap => lap.Lap),
                    bestLap: bestLap ? bestLap.toFixed(3) : '--',
                    avgLap: avgLap ? avgLap.toFixed(3) : '--',
                    topSpeed: topSpeed ? topSpeed.toFixed(1) : '--',
                    totalLaps: driver.Laps.filter(lap => lap.LapTime).length
                };
            });

            // Sort by running position
            practiceData.sort((a, b) => a.runningPos - b.runningPos);

            updateStats();
            renderTable();
        }

        function updateStats() {
            const allLapTimes = practiceData.flatMap(d => d.lapTimes);
            const allSpeeds = practiceData.flatMap(d => d.lapSpeeds);
            const totalLaps = practiceData.reduce((sum, d) => sum + d.totalLaps, 0);

            document.getElementById('totalLaps').textContent = totalLaps;
            document.getElementById('fastestLap').textContent = allLapTimes.length > 0 ? 
                Math.min(...allLapTimes).toFixed(3) : '--';
            document.getElementById('topSpeed').textContent = allSpeeds.length > 0 ? 
                Math.max(...allSpeeds).toFixed(1) : '--';
            document.getElementById('activeDrivers').textContent = practiceData.length;

            // Render all views
            renderAveragesTable();
            renderHeatmap();
            renderAdvancedHeatmap();
            selectedCompareDrivers = []; // Reset compare selection on new data
            updateCompareView();
        }

        function renderTable() {
            const tableBody = document.getElementById('driversTableBody');
            tableBody.innerHTML = '';

            practiceData.forEach((driver, index) => {
                const row = document.createElement('tr');
                row.className = 'driver-row';
                row.dataset.driverIndex = index;

                const posClass = index < 3 ? 'position top3' : 'position';

                row.innerHTML = `
                    <td class="${posClass}">${index + 1}</td>
                    <td class="driver-name">
                        <span class="car-number">${driver.number}</span>
                        ${driver.name}
                    </td>
                    <td class="best-lap">${driver.bestLap}</td>
                    <td>${driver.totalLaps}</td>
                `;

                row.addEventListener('mouseenter', () => {
                    if (!isLocked) showDriverChart(index);
                });
                
                row.addEventListener('mouseleave', () => {
                    if (!isLocked) hideDriverChart();
                });

                row.addEventListener('click', () => {
                    if (isLocked && selectedDriverIndex === index) {
                        // Unlock if clicking same driver
                        isLocked = false;
                        selectedDriverIndex = null;
                        clearBtn.style.display = 'none';
                        document.querySelectorAll('.driver-row').forEach(r => r.classList.remove('selected'));
                        hideDriverChart();
                    } else {
                        // Lock to this driver
                        isLocked = true;
                        selectedDriverIndex = index;
                        clearBtn.style.display = 'block';
                        document.querySelectorAll('.driver-row').forEach(r => r.classList.remove('selected'));
                        row.classList.add('selected');
                        showDriverChart(index);
                    }
                });

                tableBody.appendChild(row);
            });
        }

        function clearSelection() {
            isLocked = false;
            selectedDriverIndex = null;
            clearBtn.style.display = 'none';
            document.querySelectorAll('.driver-row').forEach(r => r.classList.remove('selected'));
            hideDriverChart();
        }

        function showDriverChart(driverIndex) {
            const driver = practiceData[driverIndex];

            if (driver.lapTimes.length === 0) {
                return;
            }

            // Update highlight info
            document.getElementById('highlightName').textContent = `#${driver.number} ${driver.name}`;
            document.getElementById('highlightTeam').textContent = driver.manufacturer;
            document.getElementById('highlightBest').textContent = `${driver.bestLap}s`;
            document.getElementById('highlightAvg').textContent = `${driver.avgLap}s`;
            document.getElementById('highlightLaps').textContent = driver.totalLaps;
            document.getElementById('highlightTopSpeed').textContent = `${driver.topSpeed} mph`;

            driverHighlight.classList.add('active');
            hoverInstruction.style.display = 'none';
            chartContainer.style.display = 'block';

            const ctx = document.getElementById('lapChart').getContext('2d');

            if (lapChart) {
                lapChart.destroy();
            }

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(57, 255, 20, 0.2)');
            gradient.addColorStop(1, 'rgba(57, 255, 20, 0.0)');

            const labels = driver.lapNumbers.map(n => `Lap ${n}`);
            const bestLapValue = parseFloat(driver.bestLap);
            const avgLapValue = parseFloat(driver.avgLap);

            lapChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Lap Time (seconds)',
                        data: driver.lapTimes,
                        borderColor: '#39ff14',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: driver.lapTimes.map(t => 
                            t === bestLapValue ? '#39ff14' : 
                            t > avgLapValue + 0.3 ? '#ff4444' : '#666'
                        ),
                        pointBorderColor: driver.lapTimes.map(t => 
                            t === bestLapValue ? '#39ff14' : 'transparent'
                        ),
                        pointBorderWidth: 2,
                        pointRadius: driver.lapTimes.map(t => t === bestLapValue ? 6 : 3),
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 10, 15, 0.95)',
                            titleColor: '#39ff14',
                            bodyColor: '#ccc',
                            borderColor: '#39ff14',
                            borderWidth: 1,
                            cornerRadius: 6,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const lapTime = context.raw;
                                    const speed = driver.lapSpeeds[context.dataIndex];
                                    const diff = (lapTime - bestLapValue).toFixed(3);
                                    const diffStr = diff > 0 ? `+${diff}` : diff;
                                    return [
                                        `Time: ${lapTime.toFixed(3)}s (${diffStr}s)`,
                                        `Speed: ${speed.toFixed(1)} mph`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.03)'
                            },
                            ticks: {
                                color: '#555',
                                maxRotation: 45
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.03)'
                            },
                            ticks: {
                                color: '#555',
                                callback: function(value) {
                                    return value.toFixed(2) + 's';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function hideDriverChart() {
            driverHighlight.classList.remove('active');
            hoverInstruction.style.display = 'block';
            chartContainer.style.display = 'none';

            if (lapChart) {
                lapChart.destroy();
                lapChart = null;
            }
        }

        // Load data on page load
        loadRaceList(); // Load initial race list for selected year

        // Tab switching
        document.querySelectorAll('.view-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const viewId = tab.dataset.view;
                
                // Update tab states
                document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update view states
                document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
                document.getElementById(`${viewId}-view`).classList.add('active');
                
                // Render view-specific content if data is loaded
                if (practiceData.length > 0) {
                    if (viewId === 'averages') {
                        renderAveragesTable();
                    } else if (viewId === 'heatmap') {
                        renderHeatmap();
                    } else if (viewId === 'compare') {
                        updateCompareView();
                    } else if (viewId === 'advanced') {
                        renderAdvancedHeatmap();
                    }
                }
            });
        });

        // Averages table header click sorting
        document.querySelector('.averages-table thead').addEventListener('click', (e) => {
            const th = e.target.closest('.sortable');
            if (!th || practiceData.length === 0) return;
            
            const sortKey = th.dataset.sort;
            if (averagesSortColumn === sortKey) {
                averagesSortAsc = !averagesSortAsc;
            } else {
                averagesSortColumn = sortKey;
                averagesSortAsc = true;
            }
            
            // Update header arrows
            document.querySelectorAll('.averages-table .sortable').forEach(header => {
                header.classList.remove('active-sort');
                header.querySelector('.sort-arrow').textContent = '';
            });
            th.classList.add('active-sort');
            th.querySelector('.sort-arrow').textContent = averagesSortAsc ? 'â–²' : 'â–¼';
            
            renderAveragesTable();
        });

        // Heatmap header click sorting (delegated)
        document.getElementById('heatmapContainer').addEventListener('click', (e) => {
            const th = e.target.closest('.sortable-heatmap');
            if (!th || practiceData.length === 0) return;
            
            const sortKey = th.dataset.sort;
            if (heatmapSortColumn === sortKey) {
                heatmapSortAsc = !heatmapSortAsc;
            } else {
                heatmapSortColumn = sortKey;
                heatmapSortAsc = true;
            }
            
            renderHeatmap();
        });

        // Compare Drivers functionality
        const compareColors = ['#39ff14', '#ff6b6b', '#4ecdc4', '#ffe66d', '#a855f7'];
        let selectedCompareDrivers = [];
        let compareChart = null;

        function renderCompareDriversTable() {
            const tableBody = document.getElementById('compareDriversTableBody');
            tableBody.innerHTML = '';

            practiceData.forEach((driver, index) => {
                const row = document.createElement('tr');
                row.className = 'driver-row';
                row.dataset.driverIndex = index;
                
                if (selectedCompareDrivers.includes(index)) {
                    row.classList.add('compare-selected-row');
                }

                const posClass = index < 3 ? 'position top3' : 'position';

                row.innerHTML = `
                    <td class="${posClass}">${index + 1}</td>
                    <td class="driver-name">
                        <span class="car-number">${driver.number}</span>
                        ${driver.name}
                    </td>
                    <td class="best-lap">${driver.bestLap}</td>
                    <td>${driver.totalLaps}</td>
                `;

                row.addEventListener('click', () => toggleCompareDriver(index));
                tableBody.appendChild(row);
            });
        }

        function toggleCompareDriver(driverIndex) {
            const idx = selectedCompareDrivers.indexOf(driverIndex);
            if (idx > -1) {
                selectedCompareDrivers.splice(idx, 1);
            } else if (selectedCompareDrivers.length < 5) {
                selectedCompareDrivers.push(driverIndex);
            }
            updateCompareView();
        }

        function updateCompareView() {
            renderCompareDriversTable();
            renderCompareChips();
            renderCompareChart();
            renderCompareStats();
        }

        function renderCompareChips() {
            const container = document.getElementById('compareSelected');
            
            if (selectedCompareDrivers.length === 0) {
                container.innerHTML = '<span class="no-selection">No drivers selected</span>';
                return;
            }

            container.innerHTML = selectedCompareDrivers.map((driverIdx, i) => {
                const driver = practiceData[driverIdx];
                const color = compareColors[i];
                return `<div class="compare-chip" style="background: ${color};" onclick="toggleCompareDriver(${driverIdx})">
                    #${driver.number} ${driver.name}
                    <span class="remove-chip">Ã—</span>
                </div>`;
            }).join('');
        }

        function renderCompareChart() {
            const chartContainer = document.getElementById('compareChartContainer');
            const instruction = document.getElementById('compareInstruction');

            if (selectedCompareDrivers.length === 0) {
                chartContainer.style.display = 'none';
                instruction.style.display = 'block';
                if (compareChart) {
                    compareChart.destroy();
                    compareChart = null;
                }
                return;
            }

            chartContainer.style.display = 'block';
            instruction.style.display = 'none';

            const ctx = document.getElementById('compareChart').getContext('2d');

            if (compareChart) {
                compareChart.destroy();
            }

            // Find max lap number across selected drivers
            const maxLapNum = Math.max(...selectedCompareDrivers.map(idx => 
                Math.max(...practiceData[idx].lapNumbers, 0)
            ));

            const labels = Array.from({length: maxLapNum}, (_, i) => `Lap ${i + 1}`);

            const datasets = selectedCompareDrivers.map((driverIdx, i) => {
                const driver = practiceData[driverIdx];
                const color = compareColors[i];
                
                // Create data array with nulls for missing laps
                const data = [];
                for (let lap = 1; lap <= maxLapNum; lap++) {
                    const lapIndex = driver.lapNumbers.indexOf(lap);
                    data.push(lapIndex > -1 ? driver.lapTimes[lapIndex] : null);
                }

                return {
                    label: `#${driver.number} ${driver.name}`,
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointBackgroundColor: color,
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    spanGaps: true
                };
            });

            compareChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#ccc',
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 10, 15, 0.95)',
                            titleColor: '#39ff14',
                            bodyColor: '#ccc',
                            borderColor: '#39ff14',
                            borderWidth: 1,
                            cornerRadius: 6,
                            padding: 12,
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.03)' },
                            ticks: { color: '#555', maxRotation: 45 }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.03)' },
                            ticks: {
                                color: '#555',
                                callback: (value) => value.toFixed(2) + 's'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function renderCompareStats() {
            const statsContainer = document.getElementById('compareStats');
            const statsBody = document.getElementById('compareStatsBody');

            if (selectedCompareDrivers.length === 0) {
                statsContainer.style.display = 'none';
                return;
            }

            statsContainer.style.display = 'block';

            // Calculate stats for each driver
            const driverStats = selectedCompareDrivers.map((driverIdx, i) => {
                const driver = practiceData[driverIdx];
                const avgs = calculateAverages(driver);
                const lapTimes = driver.lapTimes;
                
                // Calculate consistency (standard deviation)
                const mean = lapTimes.reduce((a, b) => a + b, 0) / lapTimes.length;
                const variance = lapTimes.reduce((sum, t) => sum + Math.pow(t - mean, 2), 0) / lapTimes.length;
                const stdDev = Math.sqrt(variance);

                return {
                    index: driverIdx,
                    color: compareColors[i],
                    driver,
                    bestLap: parseFloat(driver.bestLap) || 999,
                    avgLap: parseFloat(driver.avgLap) || 999,
                    avg5: avgs.avg5 || 999,
                    avg10: avgs.avg10 || 999,
                    totalLaps: driver.totalLaps,
                    consistency: stdDev
                };
            });

            // Find best in each category
            const bestBestLap = Math.min(...driverStats.map(d => d.bestLap));
            const bestAvgLap = Math.min(...driverStats.map(d => d.avgLap));
            const bestAvg5 = Math.min(...driverStats.map(d => d.avg5));
            const bestAvg10 = Math.min(...driverStats.map(d => d.avg10));
            const bestLaps = Math.max(...driverStats.map(d => d.totalLaps));
            const bestConsistency = Math.min(...driverStats.filter(d => d.consistency > 0).map(d => d.consistency));

            statsBody.innerHTML = driverStats.map(stat => `
                <tr>
                    <td>
                        <div class="compare-driver-name">
                            <span class="compare-color-dot" style="background: ${stat.color}"></span>
                            #${stat.driver.number} ${stat.driver.name}
                        </div>
                    </td>
                    <td class="${stat.bestLap === bestBestLap ? 'best-in-column' : ''}">${stat.bestLap.toFixed(3)}</td>
                    <td class="${stat.avgLap === bestAvgLap ? 'best-in-column' : ''}">${stat.avgLap.toFixed(3)}</td>
                    <td class="${stat.avg5 === bestAvg5 ? 'best-in-column' : ''}">${stat.avg5 < 999 ? stat.avg5.toFixed(3) : '--'}</td>
                    <td class="${stat.avg10 === bestAvg10 ? 'best-in-column' : ''}">${stat.avg10 < 999 ? stat.avg10.toFixed(3) : '--'}</td>
                    <td class="${stat.totalLaps === bestLaps ? 'best-in-column' : ''}">${stat.totalLaps}</td>
                    <td class="${stat.consistency === bestConsistency ? 'best-in-column' : ''}">${stat.consistency > 0 ? 'Â±' + stat.consistency.toFixed(3) : '--'}</td>
                </tr>
            `).join('');
        }

        // Calculate best consecutive X lap averages for a driver
        function calculateAverages(driver) {
            const laps = driver.lapTimes;
            const result = {
                avg5: null,
                avg10: null,
                avg15: null,
                avg20: null
            };

            // Find best consecutive N lap average
            function bestNLapAvg(laps, n) {
                if (laps.length < n) return null;
                let bestAvg = Infinity;
                for (let i = 0; i <= laps.length - n; i++) {
                    const window = laps.slice(i, i + n);
                    const avg = window.reduce((a, b) => a + b, 0) / n;
                    if (avg < bestAvg) bestAvg = avg;
                }
                return bestAvg;
            }

            result.avg5 = bestNLapAvg(laps, 5);
            result.avg10 = bestNLapAvg(laps, 10);
            result.avg15 = bestNLapAvg(laps, 15);
            result.avg20 = bestNLapAvg(laps, 20);

            return result;
        }

        let averagesSortColumn = 'avg10';
        let averagesSortAsc = true;

        // Render averages table
        function renderAveragesTable() {
            const tableBody = document.getElementById('averagesTableBody');
            
            // Calculate averages for all drivers
            const driversWithAvgs = practiceData.map(driver => ({
                ...driver,
                averages: calculateAverages(driver)
            }));

            // Sort based on current sort column
            driversWithAvgs.sort((a, b) => {
                let aVal, bVal;
                switch (averagesSortColumn) {
                    case 'name':
                        return averagesSortAsc ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
                    case 'best':
                        aVal = parseFloat(a.bestLap) || 999;
                        bVal = parseFloat(b.bestLap) || 999;
                        break;
                    case 'avg5':
                        aVal = a.averages.avg5 || 999;
                        bVal = b.averages.avg5 || 999;
                        break;
                    case 'avg10':
                        aVal = a.averages.avg10 || a.averages.avg5 || parseFloat(a.bestLap) || 999;
                        bVal = b.averages.avg10 || b.averages.avg5 || parseFloat(b.bestLap) || 999;
                        break;
                    case 'avg15':
                        aVal = a.averages.avg15 || 999;
                        bVal = b.averages.avg15 || 999;
                        break;
                    case 'avg20':
                        aVal = a.averages.avg20 || 999;
                        bVal = b.averages.avg20 || 999;
                        break;
                    case 'laps':
                        aVal = a.totalLaps;
                        bVal = b.totalLaps;
                        return averagesSortAsc ? bVal - aVal : aVal - bVal; // Default descending for laps
                    default:
                        aVal = a.averages.avg10 || 999;
                        bVal = b.averages.avg10 || 999;
                }
                return averagesSortAsc ? aVal - bVal : bVal - aVal;
            });

            // Find best values for highlighting
            const allAvg5 = driversWithAvgs.filter(d => d.averages.avg5).map(d => d.averages.avg5);
            const allAvg10 = driversWithAvgs.filter(d => d.averages.avg10).map(d => d.averages.avg10);
            const allAvg15 = driversWithAvgs.filter(d => d.averages.avg15).map(d => d.averages.avg15);
            const allAvg20 = driversWithAvgs.filter(d => d.averages.avg20).map(d => d.averages.avg20);

            const bestAvg5 = allAvg5.length > 0 ? Math.min(...allAvg5) : null;
            const bestAvg10 = allAvg10.length > 0 ? Math.min(...allAvg10) : null;
            const bestAvg15 = allAvg15.length > 0 ? Math.min(...allAvg15) : null;
            const bestAvg20 = allAvg20.length > 0 ? Math.min(...allAvg20) : null;

            tableBody.innerHTML = '';

            driversWithAvgs.forEach((driver, index) => {
                const row = document.createElement('tr');
                const avgs = driver.averages;

                // Use power curve for more emphasized gradient classification
                const getAvgClass = (val, bestVal, allVals) => {
                    if (val === null) return 'no-data';
                    if (val === bestVal) return 'avg-best';
                    const range = Math.max(...allVals) - Math.min(...allVals);
                    const linearThreshold = (val - bestVal) / range;
                    // Apply power curve (exponent 0.4) to emphasize differences
                    const threshold = Math.pow(linearThreshold, 0.4);
                    if (threshold < 0.35) return 'avg-good';
                    if (threshold < 0.65) return 'avg-mid';
                    return 'avg-slow';
                };

                row.innerHTML = `
                    <td class="position ${index < 3 ? 'top3' : ''}">${index + 1}</td>
                    <td class="driver-name">
                        <span class="car-number">${driver.number}</span>
                        ${driver.name}
                    </td>
                    <td class="best-lap">${driver.bestLap}</td>
                    <td class="avg-value ${getAvgClass(avgs.avg5, bestAvg5, allAvg5)}">
                        ${avgs.avg5 ? avgs.avg5.toFixed(3) : '--'}
                    </td>
                    <td class="avg-value ${getAvgClass(avgs.avg10, bestAvg10, allAvg10)}">
                        ${avgs.avg10 ? avgs.avg10.toFixed(3) : '--'}
                    </td>
                    <td class="avg-value ${getAvgClass(avgs.avg15, bestAvg15, allAvg15)}">
                        ${avgs.avg15 ? avgs.avg15.toFixed(3) : '--'}
                    </td>
                    <td class="avg-value ${getAvgClass(avgs.avg20, bestAvg20, allAvg20)}">
                        ${avgs.avg20 ? avgs.avg20.toFixed(3) : '--'}
                    </td>
                    <td>${driver.totalLaps}</td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Get color for lap time (green=fast, yellow=medium, red=slow)
        // Uses power curve for more emphasized gradient - small differences show bigger color changes
        function getLapTimeColor(lapTime, minTime, maxTime) {
            if (!lapTime || !minTime || !maxTime) return 'transparent';
            
            const range = maxTime - minTime;
            if (range === 0) return 'rgb(0, 255, 0)';
            
            // Use power curve to emphasize differences - values closer to min stay green longer,
            // but quickly shift to yellow/red as they get further from the fastest time
            const linearNorm = (lapTime - minTime) / range;
            // Apply power curve (exponent 0.4) to emphasize differences
            const normalized = Math.pow(linearNorm, 0.4);
            
            // Green (0,255,0) -> Yellow (255,255,0) -> Red (255,0,0)
            let r, g, b;
            if (normalized < 0.5) {
                // Green to Yellow
                const t = normalized * 2;
                r = Math.round(255 * t);
                g = 255;
                b = 0;
            } else {
                // Yellow to Red
                const t = (normalized - 0.5) * 2;
                r = 255;
                g = Math.round(255 * (1 - t));
                b = 0;
            }
            
            return `rgb(${r}, ${g}, ${b})`;
        }

        let heatmapSortColumn = 'avg10';
        let heatmapSortAsc = true;

        // Render heatmap
        function renderHeatmap() {
            const container = document.getElementById('heatmapContainer');

            // Calculate averages for sorting
            const driversWithAvgs = practiceData.map(driver => ({
                ...driver,
                averages: calculateAverages(driver)
            }));

            // Sort drivers based on current sort column
            let sortedDrivers = [...driversWithAvgs];
            switch (heatmapSortColumn) {
                case 'name':
                    sortedDrivers.sort((a, b) => heatmapSortAsc ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name));
                    break;
                case 'avg5':
                    sortedDrivers.sort((a, b) => {
                        const aVal = a.averages.avg5 || 999;
                        const bVal = b.averages.avg5 || 999;
                        return heatmapSortAsc ? aVal - bVal : bVal - aVal;
                    });
                    break;
                case 'avg10':
                    sortedDrivers.sort((a, b) => {
                        const aVal = a.averages.avg10 || a.averages.avg5 || parseFloat(a.bestLap) || 999;
                        const bVal = b.averages.avg10 || b.averages.avg5 || parseFloat(b.bestLap) || 999;
                        return heatmapSortAsc ? aVal - bVal : bVal - aVal;
                    });
                    break;
                case 'avg15':
                    sortedDrivers.sort((a, b) => {
                        const aVal = a.averages.avg15 || 999;
                        const bVal = b.averages.avg15 || 999;
                        return heatmapSortAsc ? aVal - bVal : bVal - aVal;
                    });
                    break;
                case 'avg20':
                    sortedDrivers.sort((a, b) => {
                        const aVal = a.averages.avg20 || 999;
                        const bVal = b.averages.avg20 || 999;
                        return heatmapSortAsc ? aVal - bVal : bVal - aVal;
                    });
                    break;
                default:
                    sortedDrivers.sort((a, b) => a.runningPos - b.runningPos);
            }

            // Find the maximum lap number across all drivers
            const maxLapNum = Math.max(...practiceData.flatMap(d => d.lapNumbers), 0);
            
            // Find global min/max lap times for color scale
            const allTimes = practiceData.flatMap(d => d.lapTimes);
            const minTime = Math.min(...allTimes);
            const maxTime = Math.max(...allTimes);

            // Build table HTML with current sort state
            const arrow = (col) => heatmapSortColumn === col ? (heatmapSortAsc ? 'â–²' : 'â–¼') : '';
            const activeClass = (col) => heatmapSortColumn === col ? 'active-sort' : '';
            
            let html = '<table class="heatmap-table"><thead><tr>';
            html += `<th class="driver-header sortable-heatmap ${activeClass('name')}" data-sort="name">Driver <span class="sort-arrow">${arrow('name')}</span></th>`;
            html += `<th class="avg-header sortable-heatmap ${activeClass('avg5')}" data-sort="avg5">Best 5 <span class="sort-arrow">${arrow('avg5')}</span></th>`;
            html += `<th class="avg-header sortable-heatmap ${activeClass('avg10')}" data-sort="avg10">Best 10 <span class="sort-arrow">${arrow('avg10')}</span></th>`;
            html += `<th class="avg-header sortable-heatmap ${activeClass('avg15')}" data-sort="avg15">Best 15 <span class="sort-arrow">${arrow('avg15')}</span></th>`;
            html += `<th class="avg-header sortable-heatmap ${activeClass('avg20')}" data-sort="avg20">Best 20 <span class="sort-arrow">${arrow('avg20')}</span></th>`;
            
            // Add lap number headers
            for (let i = 1; i <= maxLapNum; i++) {
                html += `<th>${i}</th>`;
            }
            html += '</tr></thead><tbody>';

            // Add rows for each driver
            sortedDrivers.forEach(driver => {
                html += '<tr>';
                html += `<td class="driver-cell"><span class="car-number">${driver.number}</span> ${driver.name}</td>`;
                
                // Add average cells
                const avgs = driver.averages;
                html += `<td class="avg-cell" style="color: ${avgs.avg5 ? getLapTimeColor(avgs.avg5, minTime, maxTime) : '#333'}">${avgs.avg5 ? avgs.avg5.toFixed(3) : '--'}</td>`;
                html += `<td class="avg-cell" style="color: ${avgs.avg10 ? getLapTimeColor(avgs.avg10, minTime, maxTime) : '#333'}">${avgs.avg10 ? avgs.avg10.toFixed(3) : '--'}</td>`;
                html += `<td class="avg-cell" style="color: ${avgs.avg15 ? getLapTimeColor(avgs.avg15, minTime, maxTime) : '#333'}">${avgs.avg15 ? avgs.avg15.toFixed(3) : '--'}</td>`;
                html += `<td class="avg-cell" style="color: ${avgs.avg20 ? getLapTimeColor(avgs.avg20, minTime, maxTime) : '#333'}">${avgs.avg20 ? avgs.avg20.toFixed(3) : '--'}</td>`;

                // Create a map of lap number to lap time
                const lapMap = {};
                driver.lapNumbers.forEach((lapNum, idx) => {
                    lapMap[lapNum] = driver.lapTimes[idx];
                });

                // Add lap cells
                for (let i = 1; i <= maxLapNum; i++) {
                    const lapTime = lapMap[i];
                    if (lapTime) {
                        const bgColor = getLapTimeColor(lapTime, minTime, maxTime);
                        html += `<td class="lap-cell lap-time-cell" style="background-color: ${bgColor}; color: #000; font-weight: 600;" title="Lap ${i}: ${lapTime.toFixed(3)}s">${lapTime.toFixed(2)}</td>`;
                    } else {
                        html += '<td class="lap-cell"></td>';
                    }
                }
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Advanced TEST View state
        let advancedSortColumn = 'avg10';
        let advancedSortAsc = true;
        let showRankColumns = {
            5: false,
            10: false,
            15: false,
            20: false
        };

        // Toggle rank column buttons
        document.querySelectorAll('.toggle-btn[data-rank]').forEach(btn => {
            btn.addEventListener('click', () => {
                const rank = parseInt(btn.dataset.rank);
                showRankColumns[rank] = !showRankColumns[rank];
                btn.classList.toggle('active', showRankColumns[rank]);
                renderAdvancedHeatmap();
            });
        });

        // Advanced heatmap header click sorting (delegated)
        document.getElementById('advancedHeatmapContainer').addEventListener('click', (e) => {
            const th = e.target.closest('.sortable-advanced');
            if (!th || practiceData.length === 0) return;
            
            const sortKey = th.dataset.sort;
            if (advancedSortColumn === sortKey) {
                advancedSortAsc = !advancedSortAsc;
            } else {
                advancedSortColumn = sortKey;
                advancedSortAsc = true;
            }
            
            renderAdvancedHeatmap();
        });

        // Calculate ranks for all drivers based on N-lap average
        function calculateRanks(driversWithAvgs, n) {
            const avgKey = `avg${n}`;
            const driverAvgs = driversWithAvgs.map((d, idx) => ({
                idx,
                avg: d.averages[avgKey]
            })).filter(d => d.avg !== null);
            
            // Sort by average (ascending = better)
            driverAvgs.sort((a, b) => a.avg - b.avg);
            
            // Assign ranks
            const ranks = {};
            driverAvgs.forEach((d, rank) => {
                ranks[d.idx] = rank + 1;
            });
            
            return ranks;
        }

        // Render Advanced Heatmap
        function renderAdvancedHeatmap() {
            const container = document.getElementById('advancedHeatmapContainer');
            const exportBtn = document.getElementById('exportExcelBtn');

            if (practiceData.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">Select a race to view advanced practice analytics</p>';
                exportBtn.disabled = true;
                return;
            }

            exportBtn.disabled = false;

            // Calculate averages for all drivers
            const driversWithAvgs = practiceData.map((driver, idx) => ({
                ...driver,
                originalIndex: idx,
                averages: calculateAverages(driver)
            }));

            // Calculate ranks for all drivers
            const ranks5 = calculateRanks(driversWithAvgs, 5);
            const ranks10 = calculateRanks(driversWithAvgs, 10);
            const ranks15 = calculateRanks(driversWithAvgs, 15);
            const ranks20 = calculateRanks(driversWithAvgs, 20);

            // Sort drivers based on current sort column
            let sortedDrivers = [...driversWithAvgs];
            switch (advancedSortColumn) {
                case 'name':
                    sortedDrivers.sort((a, b) => advancedSortAsc ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name));
                    break;
                case 'rank5':
                    sortedDrivers.sort((a, b) => {
                        const aVal = ranks5[a.originalIndex] || 999;
                        const bVal = ranks5[b.originalIndex] || 999;
                        return advancedSortAsc ? aVal - bVal : bVal - aVal;
                    });
                    break;
                case 'rank10':
                    sortedDrivers.sort((a, b) => {
                        const aVal = ranks10[a.originalIndex] || 999;
                        const bVal = ranks10[b.originalIndex] || 999;
                        return advancedSortAsc ? aVal - bVal : bVal - aVal;
                    });
                    break;
                case 'rank15':
                    sortedDrivers.sort((a, b) => {
                        const aVal = ranks15[a.originalIndex] || 999;
                        const bVal = ranks15[b.originalIndex] || 999;
                        return advancedSortAsc ? aVal - bVal : bVal - aVal;
                    });
                    break;
                case 'rank20':
                    sortedDrivers.sort((a, b) => {
                        const aVal = ranks20[a.originalIndex] || 999;
                        const bVal = ranks20[b.originalIndex] || 999;
                        return advancedSortAsc ? aVal - bVal : bVal - aVal;
                    });
                    break;
                case 'avg5':
                    sortedDrivers.sort((a, b) => {
                        const aVal = a.averages.avg5 || 999;
                        const bVal = b.averages.avg5 || 999;
                        return advancedSortAsc ? aVal - bVal : bVal - aVal;
                    });
                    break;
                case 'avg10':
                    sortedDrivers.sort((a, b) => {
                        const aVal = a.averages.avg10 || a.averages.avg5 || parseFloat(a.bestLap) || 999;
                        const bVal = b.averages.avg10 || b.averages.avg5 || parseFloat(b.bestLap) || 999;
                        return advancedSortAsc ? aVal - bVal : bVal - aVal;
                    });
                    break;
                case 'avg15':
                    sortedDrivers.sort((a, b) => {
                        const aVal = a.averages.avg15 || 999;
                        const bVal = b.averages.avg15 || 999;
                        return advancedSortAsc ? aVal - bVal : bVal - aVal;
                    });
                    break;
                case 'avg20':
                    sortedDrivers.sort((a, b) => {
                        const aVal = a.averages.avg20 || 999;
                        const bVal = b.averages.avg20 || 999;
                        return advancedSortAsc ? aVal - bVal : bVal - aVal;
                    });
                    break;
                default:
                    sortedDrivers.sort((a, b) => a.runningPos - b.runningPos);
            }

            // Find the maximum lap number across all drivers
            const maxLapNum = Math.max(...practiceData.flatMap(d => d.lapNumbers), 0);
            
            // Find global min/max lap times for color scale
            const allTimes = practiceData.flatMap(d => d.lapTimes);
            const minTime = Math.min(...allTimes);
            const maxTime = Math.max(...allTimes);

            // Build table HTML with current sort state
            const arrow = (col) => advancedSortColumn === col ? (advancedSortAsc ? 'â–²' : 'â–¼') : '';
            const activeClass = (col) => advancedSortColumn === col ? 'active-sort' : '';
            
            let html = '<table class="advanced-heatmap-table"><thead><tr>';
            html += `<th class="driver-header sortable-advanced ${activeClass('name')}" data-sort="name">Driver <span class="sort-arrow">${arrow('name')}</span></th>`;
            
            // Add rank columns if enabled
            if (showRankColumns[5]) {
                html += `<th class="rank-header sortable-advanced ${activeClass('rank5')}" data-sort="rank5">5L Rank <span class="sort-arrow">${arrow('rank5')}</span></th>`;
            }
            if (showRankColumns[10]) {
                html += `<th class="rank-header sortable-advanced ${activeClass('rank10')}" data-sort="rank10">10L Rank <span class="sort-arrow">${arrow('rank10')}</span></th>`;
            }
            if (showRankColumns[15]) {
                html += `<th class="rank-header sortable-advanced ${activeClass('rank15')}" data-sort="rank15">15L Rank <span class="sort-arrow">${arrow('rank15')}</span></th>`;
            }
            if (showRankColumns[20]) {
                html += `<th class="rank-header sortable-advanced ${activeClass('rank20')}" data-sort="rank20">20L Rank <span class="sort-arrow">${arrow('rank20')}</span></th>`;
            }
            
            // Add average columns
            html += `<th class="avg-header sortable-advanced ${activeClass('avg5')}" data-sort="avg5">Best 5 <span class="sort-arrow">${arrow('avg5')}</span></th>`;
            html += `<th class="avg-header sortable-advanced ${activeClass('avg10')}" data-sort="avg10">Best 10 <span class="sort-arrow">${arrow('avg10')}</span></th>`;
            html += `<th class="avg-header sortable-advanced ${activeClass('avg15')}" data-sort="avg15">Best 15 <span class="sort-arrow">${arrow('avg15')}</span></th>`;
            html += `<th class="avg-header sortable-advanced ${activeClass('avg20')}" data-sort="avg20">Best 20 <span class="sort-arrow">${arrow('avg20')}</span></th>`;
            
            // Add lap number headers
            for (let i = 1; i <= maxLapNum; i++) {
                html += `<th>${i}</th>`;
            }
            html += '</tr></thead><tbody>';

            // Add rows for each driver
            sortedDrivers.forEach(driver => {
                const driverIdx = driver.originalIndex;
                html += '<tr>';
                html += `<td class="driver-cell"><span class="car-number">${driver.number}</span> ${driver.name}</td>`;
                
                // Add rank cells if enabled
                if (showRankColumns[5]) {
                    const rank = ranks5[driverIdx];
                    const rankClass = rank <= 3 ? 'rank-top3' : (rank <= 10 ? 'rank-top10' : '');
                    html += `<td class="rank-cell ${rankClass}">${rank || '--'}</td>`;
                }
                if (showRankColumns[10]) {
                    const rank = ranks10[driverIdx];
                    const rankClass = rank <= 3 ? 'rank-top3' : (rank <= 10 ? 'rank-top10' : '');
                    html += `<td class="rank-cell ${rankClass}">${rank || '--'}</td>`;
                }
                if (showRankColumns[15]) {
                    const rank = ranks15[driverIdx];
                    const rankClass = rank <= 3 ? 'rank-top3' : (rank <= 10 ? 'rank-top10' : '');
                    html += `<td class="rank-cell ${rankClass}">${rank || '--'}</td>`;
                }
                if (showRankColumns[20]) {
                    const rank = ranks20[driverIdx];
                    const rankClass = rank <= 3 ? 'rank-top3' : (rank <= 10 ? 'rank-top10' : '');
                    html += `<td class="rank-cell ${rankClass}">${rank || '--'}</td>`;
                }
                
                // Add average cells
                const avgs = driver.averages;
                html += `<td class="avg-cell" style="color: ${avgs.avg5 ? getLapTimeColor(avgs.avg5, minTime, maxTime) : '#333'}">${avgs.avg5 ? avgs.avg5.toFixed(3) : '--'}</td>`;
                html += `<td class="avg-cell" style="color: ${avgs.avg10 ? getLapTimeColor(avgs.avg10, minTime, maxTime) : '#333'}">${avgs.avg10 ? avgs.avg10.toFixed(3) : '--'}</td>`;
                html += `<td class="avg-cell" style="color: ${avgs.avg15 ? getLapTimeColor(avgs.avg15, minTime, maxTime) : '#333'}">${avgs.avg15 ? avgs.avg15.toFixed(3) : '--'}</td>`;
                html += `<td class="avg-cell" style="color: ${avgs.avg20 ? getLapTimeColor(avgs.avg20, minTime, maxTime) : '#333'}">${avgs.avg20 ? avgs.avg20.toFixed(3) : '--'}</td>`;

                // Create a map of lap number to lap time
                const lapMap = {};
                driver.lapNumbers.forEach((lapNum, idx) => {
                    lapMap[lapNum] = driver.lapTimes[idx];
                });

                // Add lap cells
                for (let i = 1; i <= maxLapNum; i++) {
                    const lapTime = lapMap[i];
                    if (lapTime) {
                        const bgColor = getLapTimeColor(lapTime, minTime, maxTime);
                        html += `<td class="lap-cell lap-time-cell" style="background-color: ${bgColor}; color: #000; font-weight: 600;" title="Lap ${i}: ${lapTime.toFixed(3)}s">${lapTime.toFixed(2)}</td>`;
                    } else {
                        html += '<td class="lap-cell"></td>';
                    }
                }
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Export to Excel functionality
        document.getElementById('exportExcelBtn').addEventListener('click', () => {
            if (practiceData.length === 0) return;

            // Calculate all data for export
            const driversWithAvgs = practiceData.map((driver, idx) => ({
                ...driver,
                originalIndex: idx,
                averages: calculateAverages(driver)
            }));

            // Calculate ranks
            const ranks5 = calculateRanks(driversWithAvgs, 5);
            const ranks10 = calculateRanks(driversWithAvgs, 10);
            const ranks15 = calculateRanks(driversWithAvgs, 15);
            const ranks20 = calculateRanks(driversWithAvgs, 20);

            // Find max lap number
            const maxLapNum = Math.max(...practiceData.flatMap(d => d.lapNumbers), 0);

            // Build CSV content
            let csvContent = '';
            
            // Header row
            let headers = ['Driver', 'Number', '5L Rank', '10L Rank', '15L Rank', '20L Rank', 'Best 5 Avg', 'Best 10 Avg', 'Best 15 Avg', 'Best 20 Avg'];
            for (let i = 1; i <= maxLapNum; i++) {
                headers.push(`Lap ${i}`);
            }
            csvContent += headers.join(',') + '\n';

            // Data rows
            driversWithAvgs.forEach(driver => {
                const driverIdx = driver.originalIndex;
                let row = [
                    `"${driver.name}"`,
                    driver.number,
                    ranks5[driverIdx] || '',
                    ranks10[driverIdx] || '',
                    ranks15[driverIdx] || '',
                    ranks20[driverIdx] || '',
                    driver.averages.avg5 ? driver.averages.avg5.toFixed(3) : '',
                    driver.averages.avg10 ? driver.averages.avg10.toFixed(3) : '',
                    driver.averages.avg15 ? driver.averages.avg15.toFixed(3) : '',
                    driver.averages.avg20 ? driver.averages.avg20.toFixed(3) : ''
                ];

                // Create lap map
                const lapMap = {};
                driver.lapNumbers.forEach((lapNum, idx) => {
                    lapMap[lapNum] = driver.lapTimes[idx];
                });

                // Add lap times
                for (let i = 1; i <= maxLapNum; i++) {
                    row.push(lapMap[i] ? lapMap[i].toFixed(3) : '');
                }

                csvContent += row.join(',') + '\n';
            });

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Generate filename with race info
            const raceName = currentRaceName.textContent.replace(/[^a-zA-Z0-9]+/g, '_').replace(/^_|_$/g, '');
            const filename = `NASCAR_Practice_${raceName}_Advanced.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>
</html>